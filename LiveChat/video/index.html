<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LiveChat Video - Zefren</title>
    <link rel="stylesheet" href="style.css" />
  </head>

  <body onload="changeVideo()">
    <h1 id="texteAvatar" class="avatarTexte"></h1>
    <img
      id="avatar"
      class="avatarImg"
      width="150"
      height="150"
      src="https://cdn.discordapp.com/attachments/1076908168132694048/1077592007175831562/vide.png"
    />
    <h1 id="texteVid" class="contentTexte"></h1>
    <video muted id="video" src=""></video>
    <input id="btnMute" type="button" value="Unmute" style="display: none" />

    <script>
      const video = document.getElementById("video");
      const btn = document.querySelector("input");
      let texteVideo = "";
      let time = 20000;
      let height = 1080;
      let width = 1920;
      let avatar =
        "https://cdn.discordapp.com/attachments/1076908168132694048/1077592007175831562/vide.png";
      let username = "";
      const imgAvatar = document.getElementById("avatar");
      let urlRecu = "";

      function fetchDataFromDatabase() {
        const ajax = new XMLHttpRequest();
        const method = "GET";
        const url = "../getValue.php";
        const asynchronous = true;

        ajax.open(method, url, asynchronous);
        ajax.send();

        ajax.onload = function () {
          const messageRecu = this.responseText.split("$");

          if (messageRecu[3] !== urlRecu && messageRecu[3].includes(".mp4")) {
            urlRecu = messageRecu[3];
            updateTimeAndClear(messageRecu);
          }
        };
      }

      function updateTimeAndClear(messageRecu) {
        time = messageRecu[0];
        setTimeout(clearUI, time);

        width = messageRecu[1];
        video.width = width;

        height = messageRecu[2];
        video.height = height;

        avatar = messageRecu[6];
        imgAvatar.src = avatar;

        username = messageRecu[7];
        document.getElementById("texteAvatar").textContent = username;

        video.src = urlRecu;
        video.load();
        video.play();

        setTimeout(() => {
          document.getElementById("btnMute").style.display = "block";
          clickButton();
        }, 1000);

        texteVideo = messageRecu[4];
        document.getElementById("texteVid").textContent = texteVideo;
      }

      function clearUI() {
        video.src = "";
        document.getElementById("texteVid").textContent = "";
        document.getElementById("btnMute").style.display = "none";
        document.getElementById("texteAvatar").textContent = "";
        imgAvatar.src =
          "https://cdn.discordapp.com/attachments/1076908168132694048/1077592007175831562/vide.png";

        const ajax = new XMLHttpRequest();
        const method = "GET";
        const url = "../deleteValue.php";
        const asynchronous = true;

        ajax.open(method, url, asynchronous);
        ajax.send();

        ajax.onload = function () {
          console.log("suppression");
        };
      }

      btn.addEventListener("click", function () {
        document.getElementById("btnMute").style.display = "none";
        video.muted = false;
        video.volume = 0.1;
        video.play();
      });

      function clickButton() {
        btn.click();
      }

      function changeVideo() {
        setInterval(fetchDataFromDatabase, 7000);
      }
    </script>
  </body>
</html>
